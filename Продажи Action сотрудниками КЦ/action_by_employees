WITH list_action AS (
    SELECT upp.id AS id, 
           upp.user_id AS user_id, 
           signed_date::date AS signed_date, 
           status,
           upp.payment_plan_id AS payment_plan_id 
    FROM ddxfitness_prod_v2.pg_user_payment_plans upp
    WHERE upp.status <> 'Deleted' AND status <> 'Created'
      AND upp.payment_plan_id IN (205, 206)
),
all_contracts AS (
    SELECT 
        bu.id, 
        upp.id AS plan_id,
        upp.status,
        user, 
        phone, 
        user_id, 
        email, 
        CASE 
            WHEN employee_name LIKE '%Online Registration%' THEN 'Online Registration' 
            ELSE employee_name 
        END AS employee_name, 
        department,
        parseDateTimeBestEffortOrNull(change_date)::date AS change_date, 
        signed_date, 
        upp.payment_plan_id AS payment_plan_id,
        CASE 
            WHEN upp.payment_plan_id = 206 THEN 199 
            WHEN upp.payment_plan_id = 205 THEN 299 
            ELSE 0 
        END AS amount,
        CASE 
            WHEN change_date >= signed_date - INTERVAL '3' DAY 
                 AND change_date <= signed_date + INTERVAL '3' DAY 
                 AND amount = 199 THEN 1 
            WHEN change_date = signed_date THEN 1
            ELSE 0 
        END AS is_callcenter,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY change_date DESC, bu.id DESC) AS rn
    FROM ddxfitness_prod_v2.bi_ur_from_bitrix bu
    LEFT JOIN list_action upp ON bu.user_id = CAST(upp.user_id AS String)
),
table_for_tests AS (
    SELECT 
        date_diff('day', change_date, signed_date) AS diff_days, 
        * 
    FROM all_contracts 
    WHERE payment_plan_id <> 0
      AND change_date IS NOT NULL 
      AND change_date <> signed_date
)
SELECT * 
FROM all_contracts 
WHERE is_callcenter = 1 AND rn = 1;
